# Benchmark 测试框架

本目录包含长安链的性能基准测试工具，用于评估系统在不同负载下的性能表现。

## 目录结构

```
bench/
├── bench_usage.md        # 快速使用指南
├── benchmarker_stat.go   # 基准测试统计
├── grpc_sender.go        # gRPC 发送器实现
├── main.go               # 主程序入口
└── tx.go                 # 交易生成工具
```

## 核心组件

### 1. Benchmarker
- 测试流程控制
- 性能指标收集
- 结果统计分析

### 2. GRPCSender
- gRPC 连接管理
- 交易并发发送
- 响应处理

### 3. TxGenerator
- 测试交易生成
- 负载模式控制
- 签名管理

## 测试指标

1. **吞吐量指标**
   - TPS (每秒交易数)
   - 成功交易数
   - 失败交易数

2. **延迟指标**
   - 平均延迟
   - 最大延迟
   - 延迟分布

3. **资源指标**
   - CPU 使用率
   - 内存使用量
   - 网络吞吐量

## 使用指南

### 1. 基本用法

```bash
# 运行基准测试
go run main.go -config config.yaml

# 查看帮助
go run main.go -help
```

### 2. 配置示例

```yaml
benchmark:
  duration: 60s          # 测试持续时间
  tps: 1000              # 目标TPS
  workers: 10            # 并发工作线程数
  endpoint: "localhost:12301" # 链节点地址

transaction:
  type: "transfer"       # 交易类型
  payload_size: 512      # 交易负载大小(字节)
  key_count: 100000      # 可用密钥数量
```

### 3. 交易类型

1. **转账交易**
   - 简单资产转移
   - 基础性能测试

2. **合约调用**
   - 智能合约执行
   - 复杂逻辑测试

3. **混合负载**
   - 多种交易组合
   - 模拟真实场景

## 实现原理

### 1. 负载生成

```go
// 交易生成流程
1. 初始化账户和密钥
2. 根据配置生成交易模板
3. 填充交易payload
4. 签名交易
5. 加入发送队列
```

### 2. 压力测试

```go
// 测试执行流程
1. 初始化gRPC连接
2. 启动工作协程
3. 按照目标TPS发送交易
4. 收集响应结果
5. 定期输出统计
```

### 3. 结果分析

```go
// 统计指标计算
1. 计算时间窗口内TPS
2. 统计交易响应延迟
3. 分析成功率
4. 生成报告
```

## 高级功能

### 1. 自定义负载
- 修改 tx.go 实现自定义交易生成器
- 支持复杂交易模式

### 2. 分布式测试
- 多机协同测试
- 全局统计汇总

### 3. 持久化测试
- 长时间稳定性测试
- 资源泄漏检测

## 示例报告

```
=== Benchmark Report ===
Duration:      60.0s
Total TX:      58923
Success TX:    58890 (99.94%)
Failure TX:    33 (0.06%)
Average TPS:   982.05
Max TPS:       1024.87
Avg Latency:   23.4ms
Max Latency:   412ms
```

## 注意事项

1. 测试准备
   - 确保链节点正常运行
   - 准备足够的测试账户
   - 预热系统

2. 结果分析
   - 关注成功率
   - 分析延迟分布
   - 监控系统资源

3. 环境建议
   - 专用测试环境
   - 网络隔离
   - 基准测试
